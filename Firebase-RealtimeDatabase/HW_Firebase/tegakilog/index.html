<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>Canvas Drawing App</title>
<style>
  #canvas {
    border: 1px solid #000;
    cursor: crosshair;
  }
  #output img {
    max-width: 100%;
    margin: 10px 0;
  }
</style>
</head>
<body>

<!-- 描画エリア -->
<div>
  <div> 名前：<input type="text" id="uname"> </div>
  <canvas id="canvas" width="400" height="300"></canvas>
  <button id="send">送信</button>
</div>

<!-- 絵の表示エリア -->
<div id="output" style="overflow: auto; height: 300px;"></div>

<!-- JQuery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
  import { getDatabase, ref, push, set, onChildAdded } 
  from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

  // Firebase設定
  const firebaseConfig = {
    apiKey: "AIzaSyCm0lzOwfrwwalLKGt_w2vUyxtGDHrQKOA",
    authDomain: "sample-452f2.firebaseapp.com",
    projectId: "sample-452f2",
    storageBucket: "sample-452f2.appspot.com",
    messagingSenderId: "80734618426",
    appId: "1:80734618426:web:2642e0ac7d4d6f995c0603"
  };

  // Firebase初期化
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const dbRef = ref(db, "drawings");

  // Canvasの設定
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");
  let drawing = false;

  // マウス操作
  canvas.addEventListener("mousedown", (e) => { drawing = true; draw(e); });
  canvas.addEventListener("mousemove", draw);
  canvas.addEventListener("mouseup", () => drawing = false);
  canvas.addEventListener("mouseout", () => drawing = false);

  function draw(e) {
    if (!drawing) return;
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.strokeStyle = "black";

    ctx.lineTo(e.clientX - canvas.offsetLeft, e.clientY - canvas.offsetTop);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(e.clientX - canvas.offsetLeft, e.clientY - canvas.offsetTop);
  }

  // 送信ボタン
  $("#send").on("click", function() {
    const uname = $("#uname").val();
    const date = new Date().toLocaleString();
    const drawingData = canvas.toDataURL(); // 画像データを取得

    if (uname && drawingData) {
      const msg = {
        uname: uname,
        drawing: drawingData,
        timestamp: date
      };
      const newPostRef = push(dbRef);
      set(newPostRef, msg);
      
      ctx.clearRect(0, 0, canvas.width, canvas.height); // Canvasをクリア
    }
  });

  // Firebaseから描画を取得して表示
  onChildAdded(dbRef, function(data) {
    const msg = data.val();
    const h = `
      <p>
        <strong>${msg.uname}</strong><br>
        <img src="${msg.drawing}" alt="Drawing"><br>
        <span class="timestamp">${msg.timestamp}</span>
      </p>`;
    $("#output").append(h);

    // スクロールを最下部に
    $("#output").scrollTop($("#output")[0].scrollHeight);
  });

</script>

</body>
</html>
